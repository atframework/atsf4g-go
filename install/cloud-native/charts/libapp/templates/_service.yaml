{{- define "libapp.service.tpl" -}}
# libapp.service.tpl - 用于生成 Service 资源的可复用 helper
# 说明：
# - 优先从 `.Values.service` 读取配置（推荐的新结构），并兼容旧的 `.Values.port` 字段。
# - 使用 `default` 提供回退值，避免渲染时空指针或缺省导致错误。
apiVersion: v1
kind: Service
metadata:
  name: {{ include "libapp.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ include "libapp.name" . }}
    release: {{ .Release.Name }}
spec:
  # service type：支持通过 values 配置（默认 ClusterIP）
  type: {{ default "ClusterIP" .Values.service.type }}
  ports:
    - name: {{ default "project-y-server" .Values.service.name }}
      # 端口优先级：.Values.service.port -> .Values.port -> 80
      port: {{ default 7001 .Values.service.port | int }}
      # targetPort 优先使用 .Values.service.targetPort，否则回退到上面的 port
      targetPort: {{ default 7001 .Values.service.port | int }}
      protocol: {{ default "TCP" .Values.service.protocol }}
  selector:
    # selector 推荐使用 values 配置化，这里保留向后兼容的默认值
    app: {{ include "libapp.fullname" . }}
{{- end -}}
{{- define "libapp.service" -}}
{{- /* 将当前 dot 传递给 util.merge，以便模板内的 .Values/.Release 可用 */ -}}
{{- template "libapp.util.merge" (append . "libapp.service.tpl") -}}
{{- end -}}
