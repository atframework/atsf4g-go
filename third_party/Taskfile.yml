version: "3"

set: [errexit, pipefail]

shopt: [globstar]


tasks:
  xresloader-gen:
    desc: "Generate xresloader protocol code"
    cmds:
      - task: xresloader-code-gen
        vars:
          PROTOC_EXEC_BIN: '{{.PROTOC_EXEC_BIN}}'
      - task: xresloader-core-gen
        vars:
          PROTOC_EXEC_BIN: '{{.PROTOC_EXEC_BIN}}'
    silent: true

  xresloader-code-gen:
    desc: "Generate xresloader protocol code"
    dir: "{{.TASKFILE_DIR}}/xresloader/protocols/code"
    vars:
      PROTOC_EXEC_BIN: '{{.PROTOC_EXEC_BIN}}'
    cmds:
      - |
       echo "Xresloader gen portocol code start..."
       "{{.PROTOC_EXEC_BIN}}" --go_out=. --mutable_out=. --go_opt=paths=source_relative --mutable_opt=paths=source_relative --proto_path=. protocol/extension/xrescode_extensions_v3.proto
       echo "Xresloader gen portocol code done."
    silent: true

  xresloader-core-gen:
    desc: "Generate xresloader protocol code for core"
    dir: "{{.TASKFILE_DIR}}/xresloader/protocols/core"
    vars:
      PROTOC_EXEC_BIN: '{{.PROTOC_EXEC_BIN}}'
    cmds:
      - |
       echo "Xresloader gen portocol core start..."
       "{{.PROTOC_EXEC_BIN}}" --go_out=. --mutable_out=. --go_opt=paths=source_relative --mutable_opt=paths=source_relative --proto_path=. protocol/config/pb_header_v3.proto
       "{{.PROTOC_EXEC_BIN}}" --go_out=. --mutable_out=. --go_opt=paths=source_relative --mutable_opt=paths=source_relative --proto_path=. protocol/extension/v3/xresloader.proto protocol/extension/v3/xresloader_ue.proto
       echo "Xresloader gen portocol core done."
    silent: true