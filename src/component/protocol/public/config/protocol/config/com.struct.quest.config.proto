syntax = "proto3";

option optimize_for = SPEED;
// option optimize_for = LITE_RUNTIME;
// option optimize_for = CODE_SIZE;
// --cpp_out=lite:,--cpp_out=
option cc_enable_arenas = true;

option go_package = "github.com/atframework/atsf4g-go/component-protocol-public/config/protocol/config";

import "protocol/extension/xrescode_extensions_v3.proto";
import "protocol/extension/v3/xresloader.proto";

import "protocol/common/com.struct.base.common.proto";
import "protocol/common/com.struct.item.common.proto";

import "protocol/common/com.struct.quest.common.proto";
import "protocol/common/com.struct.condition.common.proto";

import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";

package proy.config;

// Quest
message ExcelQuestList {
  option (xrescode.loader) = {
    file_path: "quest_list.bytes"
    indexes: { fields: "id" index_type: EN_INDEX_KV }
    indexes: { fields: "activity_id" index_type: EN_INDEX_KL allow_not_found: true }
    indexes: { fields: "random_pool_id" index_type: EN_INDEX_KL allow_not_found: true }
    indexes: { fields: "client_submit_type" index_type: EN_INDEX_KL allow_not_found: true }
    indexes: { fields: "season_id" index_type: EN_INDEX_KL allow_not_found: true }
    indexes: {
      fields: "activity_id"
      fields: "display_position"
      fields: "display_group"
      index_type: EN_INDEX_KL
      allow_not_found: true
    }
    tags: "client"
    tags: "server"
  };

  int32 id = 1 [(org.xresloader.field_unique_tag) = "id", (org.xresloader.validator) = "1600000-1699999"];
  int32 activity_id = 2;
  bool on = 3;                                                                            // 是否上架
  int32 random_pool_id = 4 [(org.xresloader.validator) = "16500-16999|1710000-1719999"];  // option
  int32 random_pool_weight = 5;                                                           // option
  EnQuestType type = 6;                                                                   // 业务逻辑
  EnQuestDisplayType display_type = 7;
  bool received_reset = 8;  // 是否领取完奖励就重置
  int32 adventure_id = 9;
  repeated int32 delete_after_unlock = 10 [(org.xresloader.field_separator) = ","];
  string name = 11;
  int32 display_position = 12;  // 客户端展示位置
  string base_pic = 13;         // 任务底图
  int32 display_order = 14;
  int32 display_group = 15 [(org.xresloader.validator) = "1720000-1729999"];  // 同一个 display_position 下的分组

  DQuestAvailablePeriodType available_period = 21;                                                     // 生命周期
  repeated DQuestUnlockConditionItem unlock_conditions = 22 [(org.xresloader.field_separator) = ";"];  // 解锁条件 and
  DConditionBasicLimit common_condition = 23;
  DQuestProgressResetInfo progress_reset_period = 24;
  repeated DQuestConditionProgress progress = 25;  // or
  DQuestReward rewards = 26;
  // int32 add_progress = 27;  // 完成任务后对其他任务的加成值
  int32 season_id = 28;  // 赛季id，目前和第一个任务进度的赛季id相同

  int32 client_submit_type = 50;      // 客户端用的字段
  string redirect_addr = 51;          // 用来跳转到某些界面或者网页啥的
  string steam_achievement_api = 52;  // steam成就api
  string steam_statistic_api = 53;    // steam统计api
}

message DQuestSpecificAvailableTimePeriod {
  google.protobuf.Timestamp start = 1;
  google.protobuf.Timestamp end = 2;
}

message DQuestSpecificAvailableSeasonPeriod {
  int32 competition_level_id = 1;
  int32 season_id = 2;
}

message DQuestAvailablePeriodType {
  int32 type = 101;
  oneof value {
    DQuestSpecificAvailableTimePeriod specific_period = 1;           // 指定有效的时间短
    int64 timedesc = 2;                                              // 接任务后开始倒计时
    DQuestSpecificAvailableSeasonPeriod specific_season_before = 3;  // 指定赛季之前
    string package_version = 4;                                      // 客户端app版本号
    string resource_version = 5;                                     // 客户端资源版本号
  }  // 不填是解锁后永久有效
}

message DQuestProgressResetInfo {
  int32 period_days = 1;
  google.protobuf.Timestamp start_day_reset_timepoint = 2;
}

/*
|用魔剑士|在每天晚上8点到10点|大乱斗模式|累计|击杀了|5只 |哥布林
|在大乱斗模式                       |单场战斗|打开了 |5个|传奇宝箱
|                                         |到达了 |1次|地牢的|x位置
|用长剑|在城堡地图|pve模式|                   |破坏了|5个 |破木头箱子
|谓词                              |动词修饰词| 动词 |数量|实体信息

动词是进度op
谓词配置在进度op_condition或者通用condition里面
数量配置在value里面
实体信息配置在 entity_args
*/

message DQuestConditionProgress {
  EnQuestProgressType type_id = 1;
  repeated int64 condition_ids = 2 [(org.xresloader.validator) = "ExcelConditionPool_condition_id"];  // and
  int64 value = 3;
  EnQuestProgressCountType count_type = 4;
  repeated int32 entity_args = 5 [(org.xresloader.field_separator) = ","];
  repeated int32 ignore_entity_args = 6 [(org.xresloader.field_separator) = ","];  // 需要忽略的entity
  int32 season_id = 7;
}

message DQuestReward {
  repeated DItemOffset items = 1 [(org.xresloader.field_separator) = ";"];
  EnQuestRewardGiveOutType give_out_type = 2;
  int32 mail_template_id = 3;  // 只有发放到邮箱的时候这个字段才需要填

  google.protobuf.Timestamp can_receive_date = 11;
  DQuestDynamicReward dynamic = 28;  // 自选奖励
}

message DQuestDynamicReward {
  EnItemDynamicType type = 1;
  repeated DQuestDynamicRewardItem details = 4;
}

message DQuestDynamicRewardItem {
  int32 key = 1;  // EnItemDynamicType 对应的实例ID
  repeated DItemOffset items = 2 [(org.xresloader.field_separator) = ";"];
}

enum EnQuestRewardGiveOutType {
  EN_QUEST_REWARD_GIVE_OUT_TYPE_MANUAL = 0;          // 手动领取
  EN_QUEST_REWARD_GIVE_OUT_TYPE_AUTO_INVENTORY = 1;  // 自动领取
}

message ExcelQuestProgressType {
  option (xrescode.loader) = {
    file_path: "quest_progress_type.bytes"
    indexes: { fields: "id" index_type: EN_INDEX_KV }

    tags: "client"
    tags: "server"
  };

  int32 id = 1 [(org.xresloader.field_unique_tag) = "id"];
  EnQuestProgressValueCompareType value_compare_type = 11;
}
// QuestTriggerEventType
message ExcelQuestTriggerEventType {
  option (xrescode.loader) = {
    file_path: "quest_trigger_event_type.bytes"
    indexes: { fields: "id" index_type: EN_INDEX_KV }

    tags: "client"
    tags: "server"
  };

  EnQuestTriggerType id = 1 [(org.xresloader.field_unique_tag) = "id"];

  repeated int32 unlock_condition_types = 10
      [(org.xresloader.validator) = "proy.DQuestUnlockConditionItem.unlock_type"];
  repeated EnQuestProgressType progress_types = 11 [(org.xresloader.validator) = "proy.EnQuestProgressType"];
}