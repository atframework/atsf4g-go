syntax = "proto3";

option optimize_for = SPEED;
// option optimize_for = LITE_RUNTIME;
// option optimize_for = CODE_SIZE;
// --cpp_out=lite:,--cpp_out=
option cc_enable_arenas = true;

option go_package = "github.com/atframework/atsf4g-go/component-protocol-private/pbdesc/protocol/pbdesc";

import "google/protobuf/any.proto";
import "google/protobuf/timestamp.proto";

import "protocol/pbdesc/svr.struct.proto";
import "protocol/extension/svr.database.extension.proto";

package proy;

message database_table_access {
  // clang-format off
  option (atframework.database_table) = {
    index: {
      name: "access"
      type: EN_ATFRAMEWORK_DB_INDEX_TYPE_KV
      split_type: EN_ATFRAMEWORK_DB_TABLE_SPLIT_TYPE_WORLD_ZONE
      key_fields: "zone_id"
      key_fields: "user_id"
    }
  };
  // clang-format on
  uint64 user_id = 1;
  uint32 zone_id = 2;
  string access_secret = 3;
  string login_code = 4;
}

message database_table_login_lock {
  // clang-format off
  option (atframework.database_table) = {
    index: {
      name: "login_lock"
      type: EN_ATFRAMEWORK_DB_INDEX_TYPE_KV
      split_type: EN_ATFRAMEWORK_DB_TABLE_SPLIT_TYPE_WORLD_ZONE
      enable_cas: true
      key_fields: "user_id"
    }
  };
  // clang-format on
  uint64 user_id = 1;
  uint64 router_server_id = 2;  // 路由系统 - 登入进程id
  uint64 router_version = 3;    // 路由系统 - 登入进程变更版本号

  uint32 login_zone_id = 11;  // 登入区服ID
  int64 login_expired = 12;   // 登入进程过期时间（时间戳）
  string login_code = 13;     // 认证码
  // 限制登入信息
  int64 ban_time = 14;  // 封号期限

  // 资源冲突检测
  uint64 expect_table_user_db_version = 21;
  google.protobuf.Timestamp expect_table_user_db_timeout = 22;
}

message database_table_user_async_jobs_blob_data {
  // action的 唯一ID，用于容灾
  string action_uuid = 1;
  int64 timepoint_ms = 2;

  // 如果失败了，内置的剩余重试次数
  int32 left_retry_times = 3;

  oneof action {
    user_async_job_debug_message debug_message = 101;  // 调试消息
  }
}

message database_table_user_async_jobs_cache_blob_data {
  user_async_jobs_data async_jobs = 1;  // 异步任务缓存

  message retry_job_data {
    int32 job_type = 1;
    database_table_user_async_jobs_blob_data job_data = 2;
  };
  repeated retry_job_data retry_jobs = 11;
}

message database_table_user {
  // clang-format off
  option (atframework.database_table) = {
    index: {
      name: "user"
      type: EN_ATFRAMEWORK_DB_INDEX_TYPE_KV
      split_type: EN_ATFRAMEWORK_DB_TABLE_SPLIT_TYPE_WORLD_ZONE
      enable_cas: true
      key_fields: "zone_id"
      key_fields: "user_id"
      partly_get: {
        name: "basic_info"
        fields: "open_id"
        fields: "login_data"
        fields: "account_data"
        fields: "user_data"
        fields: "data_version"
      }
    }
  };
  // clang-format on

  string open_id = 1;
  uint64 user_id = 2;
  uint32 zone_id = 3;

  // BasicInfo
  login_data login_data = 11;             // 登入数据
  account_information account_data = 12;  // 账号信息
  user_data user_data = 13;               // 玩家基础数据
  uint64 data_version = 14;               // 数据版本号
  // BasicInfo

  // 以下是服务器内部数据
  // 异步任务缓存
  database_table_user_async_jobs_cache_blob_data async_job_blob_data = 101;
  bool create_init = 103;      // 是否已经执行过创建初始化

  // 业务逻辑数据
  user_options_data options_data = 200;  // 玩家选项
  user_inventory_data inventory_data = 201;
  user_quest_data quest_data = 202;
  user_condition_data condition_data = 203;
  user_unlock_data unlock_data = 204;
  user_module_unlock_data module_unlock_data = 205;
}

message database_table_distribute_transaction {
  // clang-format off
  option (atframework.database_table) = {
    index: {
      name: "distribute_transaction"
      type: EN_ATFRAMEWORK_DB_INDEX_TYPE_KV
      split_type: EN_ATFRAMEWORK_DB_TABLE_SPLIT_TYPE_WORLD
      enable_cas: true
      key_fields: "zone_id"
      key_fields: "transaction_uuid"
    }
  };
  // clang-format on

  uint32 zone_id = 1;
  bytes transaction_uuid = 2;

  google.protobuf.Any blob_data = 11;
}
